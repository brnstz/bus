- hosts: db
  become: yes
  become_user: root
  vars:
    - postgresql_version: 9.4
  vars_files:
    - "group_vars/defaults.yml"
    - "group_vars/{{ inventory }}.yml"
  tasks:
    - name: Add PostgreSQL key to apt
      apt_key: url='https://www.postgresql.org/media/keys/ACCC4CF8.asc'

    - name: Add PostgreSQL repo to apt
      apt_repository: repo='deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main' state=present

    - name: Install needed packages
      apt: update_cache=yes pkg="{{ item }}" state=installed
      with_items:
        - "postgresql-{{ postgresql_version }}"
        - "postgresql-contrib-{{ postgresql_version }}"
        - "postgresql-{{ postgresql_version }}-postgis-2.2"
        - monit

    - name: Install pg_hba.conf
      template: src=templates/pg_hba.conf.j2 dest="/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf" owner=postgres group=postgres mode=640

    - name: Reload PostgreSQL config
      service: name=postgresql state=reloaded

    # If there is no backup, then create a blank schema
    - name: Copy schema file
      copy: src=../schema/schema.sql dest=/tmp/schema.sql
      when: initial_db_backup is undefined or initial_db_backup == ""

    - name: Load schema
      shell: psql -U postgres < /tmp/schema.sql
      when: initial_db_backup is undefined or initial_db_backup == ""

    # If there is a backup, then empty the db and use the backup
    - name: Get the db backup file
      get_url: url="{{ initial_db_backup }}" dest=/tmp/initial_db_backup.sql.gz force=yes
      when: initial_db_backup is defined and initial_db_backup != ""

    # Clear the database and load the backup file
    - name: Load db backup
      shell: echo "DROP SCHEMA PUBLIC CASCADE; CREATE SCHEMA PUBLIC;" | psql -U postgres && gunzip --stdout /tmp/initial_db_backup.sql.gz | psql -U postgres
      when: initial_db_backup is defined and initial_db_backup != ""

    - name: Install db monit config
      template: src=templates/db_monit.conf.j2 dest=/etc/monit/conf.d/db_monit.conf owner=root group=root mode=644

    - name: Reload monit config
      service: name=monit state=reloaded
